name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€
on: [push]
jobs:
    rspec:
      name: Run RSpec tests
      runs-on: ubuntu-latest
      
      services:
        postgres:
          image: postgres
          env:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: api_rails_oneorder_test
          ports:
              - 5432:5432
          options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      steps:
        - name: Checkout Repository
          uses: actions/checkout@v2
          timeout-minutes: 2
        - name: Setup Ruby
          uses: ruby/setup-ruby@v1
          with: 
              ruby-version: 3.2.3
        - name: Install dependencies
          run: bundle install
        - name: Run tests
          env:
            RAILS_ENV: test
            DATABASE_URL: postgres://postgres:postgres@localhost:5432
          run: |
            bundle exec rails db:create
            bundle exec rails db:migrate
            bundle exec rspec
    push:
      name: Push to Docker Hub
      runs-on: ubuntu-latest
      needs: rspec
      steps:
        - name: Checkout Repository
          uses: actions/checkout@v2
          timeout-minutes: 2
        - name: Setup Ruby
          uses: ruby/setup-ruby@v1
          with: 
              ruby-version: 3.2.3
        - name: Build and push Docker image
          run: |
            echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            docker build . -t ${{ secrets.DOCKER_USERNAME }}/github-actions-demo:${{github.ref_name}}
            docker push ${{ secrets.DOCKER_USERNAME }}/github-actions-demo
    build:
      runs-on: ubuntu-latest
      steps:
        - name: Check out the repo
          uses: actions/checkout@v2
  
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v1
  
        - name: Login to DockerHub
          uses: docker/login-action@v1
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}
  
        - name: Build and push
          uses: docker/build-push-action@v2
          with:
            context: .
            file: ./Dockerfile
            push: true
            tags: user/app:latest,user/app:${{ github.ref_name }}
            build-args: TAGGED_COMMIT=${{ startsWith(github.ref, 'refs/tags/') }}
  
        - name: Push tag
          if: startsWith(github.ref, 'refs/tags/')
          run: docker push user/app:${{ github.ref_name }}


      
