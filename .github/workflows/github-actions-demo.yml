name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€
on: [push]
jobs:
    rspec:
      name: Run RSpec tests
      runs-on: ubuntu-latest
      
      services:
        postgres:
          image: postgres
          env:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: api_rails_oneorder_test
          ports:
              - 5432:5432
          options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      steps:
        - name: Checkout Repository
          uses: actions/checkout@v2
          timeout-minutes: 2
        - name: Setup Ruby
          uses: ruby/setup-ruby@v1
          with: 
              ruby-version: 3.2.3
        - name: Install dependencies
          run: bundle install
        - name: Run tests
          env:
            RAILS_ENV: test
            DATABASE_URL: postgres://postgres:postgres@localhost:5432
          run: |
            bundle exec rails db:create
            bundle exec rails db:migrate
            bundle exec rspec
    push:
      name: Push to Docker Hub
      runs-on: ubuntu-latest
      needs: rspec
      steps:
        - name: Checkout Repository
          uses: actions/checkout@v2
          timeout-minutes: 2
        - name: Setup Ruby
          uses: ruby/setup-ruby@v1
          with: 
              ruby-version: 3.2.3
        - name: Build and push Docker image
          run: |
            echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            docker build -t ${{ secrets.DOCKER_USERNAME }}/github-actions-demo .
            docker push ${{ secrets.DOCKER_USERNAME }}/github-actions-demo
  



      
